---
- name: Check if Docker is already installed
  ansible.builtin.command: which docker
  register: ats_docker_installed
  changed_when: false
  failed_when: false

- name: Install Docker runtime packages (only if not present)
  ansible.builtin.apt:
    name: "{{ ats_rootless_docker_packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: ats_docker_installed.rc != 0

- name: Ensure subuid entry exists for service user
  ansible.builtin.lineinfile:
    path: /etc/subuid
    regexp: "^{{ ats_service_user }}:"
    line: "{{ ats_service_user }}:{{ ats_rootless_subid_range_start }}:{{ ats_rootless_subid_range_size }}"
    state: present

- name: Ensure subgid entry exists for service user
  ansible.builtin.lineinfile:
    path: /etc/subgid
    regexp: "^{{ ats_service_user }}:"
    line: "{{ ats_service_user }}:{{ ats_rootless_subid_range_start }}:{{ ats_rootless_subid_range_size }}"
    state: present

- name: Enable linger for service user
  ansible.builtin.command: "loginctl enable-linger {{ ats_service_user }}"
  changed_when: false

- name: Resolve service user uid for rootless runtime dir
  ansible.builtin.command: "id -u {{ ats_service_user }}"
  register: ats_service_user_uid
  changed_when: false

- name: Build rootless XDG runtime directory path
  ansible.builtin.set_fact:
    ats_rootless_xdg_runtime_dir: "/run/user/{{ ats_service_user_uid.stdout }}"

- name: Install rootless Docker in service user context
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: dockerd-rootless-setuptool.sh install --force
  environment:
    XDG_RUNTIME_DIR: "{{ ats_rootless_xdg_runtime_dir }}"
  changed_when: false

- name: Ensure rootless Docker user service is enabled and started
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.systemd_service:
    name: docker.service
    scope: user
    state: started
    enabled: true
  environment:
    XDG_RUNTIME_DIR: "{{ ats_rootless_xdg_runtime_dir }}"

- name: Verify rootless Docker daemon responds
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command:
    argv:
      - docker
      - info
      - --format
      - "{{ ats_docker_info_server_version_format }}"
  register: ats_rootless_docker_info_version
  changed_when: false
  environment:
    XDG_RUNTIME_DIR: "{{ ats_rootless_xdg_runtime_dir }}"

- name: Verify rootless Docker security options
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command:
    argv:
      - docker
      - info
      - --format
      - "{{ ats_docker_info_security_options_format }}"
  register: ats_rootless_docker_security_options
  changed_when: false
  environment:
    XDG_RUNTIME_DIR: "{{ ats_rootless_xdg_runtime_dir }}"

- name: Assert rootless Docker is active in daemon security options
  ansible.builtin.assert:
    that:
      - "'rootless' in ats_rootless_docker_security_options.stdout"
    fail_msg: "Rootless Docker is not active for service user {{ ats_service_user }}."

- name: Verify Docker Compose plugin availability
  become: true
  become_user: "{{ ats_service_user }}"
  ansible.builtin.command: docker compose version
  changed_when: false
  environment:
    XDG_RUNTIME_DIR: "{{ ats_rootless_xdg_runtime_dir }}"
