{% extends "dashboard/base.html" %}

{% block content %}
  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h2 class="h5 mb-2">Detalhe do Caso</h2>
          <code class="small">{{ case_id }}</code>
        </div>
        <span class="badge text-bg-dark">{{ status }}</span>
      </div>
    </div>
  </section>

  <section id="case-timeline" class="card shadow-sm">
    <div class="card-body">
      <h3 class="h6 mb-3">Timeline Cronologica</h3>
      {% if timeline_rows %}
        <ol class="list-group list-group-numbered">
          {% for row in timeline_rows %}
            <li class="list-group-item py-3">
              <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                <span class="badge {{ row.source_badge_class }}">{{ row.source }}</span>
                <span class="badge {{ row.channel_badge_class }}">{{ row.channel }}</span>
                <span class="badge {{ row.event_badge_class }}">{{ row.event_type }}</span>
                <small class="text-secondary">{{ row.timestamp }}</small>
              </div>
              <p class="mb-1"><strong>Ator:</strong> {{ row.actor }}</p>
              {% if row.excerpt_text %}
                <p class="mb-2">{{ row.excerpt_text }}</p>
              {% endif %}
              {% if row.can_show_full_content and row.full_text and row.is_truncated %}
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  data-toggle-full="timeline-full-{{ loop.index }}"
                  aria-expanded="false"
                >
                  Exibir conteudo completo
                </button>
                <pre
                  id="timeline-full-{{ loop.index }}"
                  class="mt-2 p-2 bg-light border rounded small d-none"
                >{{ row.full_text }}</pre>
              {% elif row.is_truncated %}
                <p class="small text-secondary mb-0">
                  Conteudo completo restrito ao perfil autorizado.
                </p>
              {% endif %}
            </li>
          {% endfor %}
        </ol>
      {% else %}
        <p class="text-secondary mb-0">Nao ha eventos de timeline para este caso.</p>
      {% endif %}
    </div>
  </section>
  <script>
    document.addEventListener("click", function (event) {
      const button = event.target.closest("[data-toggle-full]");
      if (!button) {
        return;
      }
      const targetId = button.getAttribute("data-toggle-full");
      if (!targetId) {
        return;
      }
      const target = document.getElementById(targetId);
      if (!target) {
        return;
      }
      const isExpanded = button.getAttribute("aria-expanded") === "true";
      if (isExpanded) {
        target.classList.add("d-none");
        button.setAttribute("aria-expanded", "false");
        button.textContent = "Exibir conteudo completo";
      } else {
        target.classList.remove("d-none");
        button.setAttribute("aria-expanded", "true");
        button.textContent = "Ocultar conteudo completo";
      }
    });
  </script>
{% endblock %}
